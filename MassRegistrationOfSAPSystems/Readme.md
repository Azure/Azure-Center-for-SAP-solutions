## At scale registration of existing SAP systems running on Azure

This example script enables you to register SAP systems at scale with Azure Center for SAP solutions. 

Before getting started with registering systems, make sure to review the [pre-requisites](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/register-existing-system#prerequisites) and [supported systems](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/register-existing-system#supported-systems).

The example script described in this article can be run from any Powershell 5.1 Console (eg. Local machine, Virtual Machine, Azure CloudShell etc.) which can access Azure resources.

### Steps to register your SAP systems at scale:
1. Install the [Az.Workloads](https://learn.microsoft.com/en-us/powershell/module/az.workloads/?view=azps-10.0.0) PowerShell module for your PowerShell environment.
   
3. Prepare a csv file with details about your SAP systems using this [template](https://github.com/Azure/Azure-Center-for-SAP-solutions/blob/main/MassRegistrationOfSAPSystems/RegistrationData.csv). The attributes which need to be included in the input file are:
    1. SID name for the SAP systems you are registering.
    2. ACSS service location based on the region in which your SAP system resources are present. You can look up the corresponding ACSS service location using [this documentation](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/quickstart-register-system-powershell#:~:text=SAP%20application%20location-,Azure%20Center%20for%20SAP%20solutions%20service%20location,-East%20US).
    3. Environment type for the SAP system, that is Prod or NonProd.
    4. SAP product for the SID being registered. Valid values are S/4HANA, ECC and Other.
    5. SAP Central Services (ASCS) virtual machine resource identifier.
    6. User assigned managed identity with the [right permissions](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/register-existing-system#setup-user-assigned-managed-identity).
    7. Optionally, you can provide the names for Managed Resource Group and Managed Storage Account that will be created as part of the registration process. If you do not provide these names, ACSS service deploys them using its default naming convention.
    8. For the resources which [get deployed](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/register-existing-system#:~:text=When%20you%20register%20a%20system%20with%20Azure%20Center%20for%20SAP%20solutions%2C%20the%20following%20resources%20are%20created%20in%20your%20Subscription%3A) as part of registration process, you can optionally add any tags that you need. The [sample input file](https://github.com/Azure/Azure-Center-for-SAP-solutions/blob/main/MassRegistrationOfSAPSystems/RegistrationData.csv) shows how multiple tag name-value pairs can be added for each system being registered.
    9. State field in the input file can be ignored.
        
4. Download the example [PowerShell script](https://github.com/Azure/Azure-Center-for-SAP-solutions/blob/main/MassRegistrationOfSAPSystems/RegisterSIDs.ps1). Script has the below parameters which need to be input as arguments:
   1. InputFile - This is a mandatory parameter which represents the path of the csv file which has the data for the SAP systems which are going to be registered. Sample file can be found [here](https://github.com/Azure/Azure-Center-for-SAP-solutions/blob/55e5c88021ec16e42084446792cf6de51d897e11/MassRegistrationOfSAPSystems/RegistrationData.csv).
   2. OutputFile - This is a mandatory parameter which represents the path of output csv file which will be generated by the script with the status of the registration process. Sample file can be found [here](https://github.com/Azure/Azure-Center-for-SAP-solutions/blob/main/MassRegistrationOfSAPSystems/RegistrationDataOutput.csv).
   3. MonitoringIntervalInSeconds -- This is an optional parameter which specifies the number of seconds for which script waits to check the status of jobs during execution. Default value is 30 seconds.
   4. MaxParallelJobs - This is an optional parameter which specifies the limit of parallel jobs that can run at a time. Default value is 10.
      
5. Use [Get-Help](https://learn.microsoft.com/powershell/module/microsoft.powershell.core/get-help?view=powershell-5.1) cmdlet to get information about the script and parameters.

6. Run the script to register SAP systems with ACSS. The script reads data from the input file and triggers parallel jobs for registration of systems.
   #### Sample command for Windows:
   C:\ AcssRegistration\RegisterSIDs.ps1 -InputFile "C:\input\RegistrationData.csv" -OutputFile "C:\output\RegistrationDataOutput.csv"

   #### Sample command for Linux:
   pwsh -Command "/home/user/acssRegistration/RegisterSIDs.ps1 -InputFile /home/user/acssRegistration /RegistrationData.csv -OutputFile /home/user/acssRegistration /RegistrationDataOutput.csv"

7. See the systems being registered on the [Azure Portal](https://aka.ms/acssvislist) Virtual Instance for SAP solutions page.
8. Once the Registration is complete, verify the status of each SID in the output file and from the Azure Portal.

### Troubleshooting:
In case of any errors with registration, you can see the error message on the script console. For detailed error messages, go to the Azure Portal and navigate to the overview page for the specific Virtual Instance for SAP solutions resource that failed to register and see error information.

You can take the necessary steps to resolve the errors based on recommended actions in the error message. If you need help with resolving any of the issues, you can raise a support ticket from within the ACSS page on the portal.
